{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Exporter les Présences{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exporter les Présences</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
</head>

<body>
    <div class="container mt-5">
        <header>
            <h1>Exporter les Présences</h1>
        </header>

        <!-- Formulaire de sélection -->
        <form id="filterForm" class="mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label for="classeSelect" class="form-label">Sélectionner une classe :</label>
                    <select id="classeSelect" name="classe_id" class="form-control">
                        <option value="">-- Choisir une classe --</option>
                        {% for classe in classes %}
                            <option value="{{ classe.id }}" {% if selected_classe and selected_classe.id == classe.id %}selected{% endif %}>
                                {{ classe.nom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Date de début :</label>
                    <input type="date" id="startDate" name="start_date" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Date de fin :</label>
                    <input type="date" id="endDate" name="end_date" class="form-control">
                </div>
            </div>
        </form>

        <!-- Conteneur des présences -->
        <div id="contentContainer">
            {% include 'partials/presences_list.html' %}
        </div>

        <!-- Boutons d'exportation -->
        <div id="exportButtons" class="d-flex mt-4" style="display: none;">
            <a id="exportPdfCours" class="btn btn-danger me-3">Exporter en PDF (par Cours)</a>
            <a id="exportPdfEleve" class="btn btn-warning">Exporter en PDF (par Élève)</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const classeSelect = document.getElementById('classeSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const contentContainer = document.getElementById('contentContainer');
        const exportButtons = document.getElementById('exportButtons');
        const exportPdfCours = document.getElementById('exportPdfCours');
        const exportPdfEleve = document.getElementById('exportPdfEleve');

        // Fonction pour obtenir le premier et dernier jour du mois actuel
        function getMonthBounds() {
            let today = new Date();
            let year = today.getFullYear();
            let month = today.getMonth(); // 0 = janvier, 1 = février...

            let firstDay = `${year}-${String(month + 1).padStart(2, '0')}-01`;

            // Calcul du dernier jour du mois sans problème de fuseau horaire
            let lastDayDate = new Date(year, month + 1, 0);
            let lastDay = `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDayDate.getDate()).padStart(2, '0')}`;

            return { firstDay, lastDay };
        }

        // Définir les valeurs par défaut au premier chargement uniquement si vide
        if (!startDateInput.value || !endDateInput.value) {
            let bounds = getMonthBounds();
            startDateInput.value = bounds.firstDay;
            endDateInput.value = bounds.lastDay;
        }

        // Met à jour les données en fonction des changements
        function updateContent() {
            let classeId = classeSelect.value;
            let startDate = startDateInput.value;
            let endDate = endDateInput.value;

            if (!classeId || !startDate || !endDate) {
                contentContainer.innerHTML = '<p class="text-muted">Sélectionnez une classe et une période pour afficher les présences.</p>';
                exportButtons.style.display = 'none';
                return;
            }

            fetch(`{% url 'filter_presences' %}?classe_id=${classeId}&start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.text())
                .then(html => {
                    contentContainer.innerHTML = html;
                    exportPdfCours.href = `{% url 'export_presences_pdf' %}?classe_id=${classeId}&start_date=${startDate}&end_date=${endDate}`;
                    exportPdfEleve.href = `{% url 'export_presences_par_eleve_pdf' %}?classe_id=${classeId}&start_date=${startDate}&end_date=${endDate}`;
                    exportButtons.style.display = 'flex';
                })
                .catch(error => console.error('Erreur lors du chargement des présences:', error));
        }

        // Détecter les changements et mettre à jour automatiquement
        classeSelect.addEventListener('change', updateContent);
        startDateInput.addEventListener('change', updateContent);
        endDateInput.addEventListener('change', updateContent);

        // Charger les données au début
        updateContent();
    });
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
{% endblock %}
